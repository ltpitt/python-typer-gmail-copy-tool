# GitHub Copilot Instructions for python-typer-gmail-copy-tool

This repository contains a Python-based CLI tool designed for Gmail account management tasks such as analyzing, copying, comparing, and cleaning emails. It uses the Gmail API and is built with Typer for an intuitive CLI interface.

## Project Overview

### Key Features
- **Email Migration**: Copy emails (including attachments, labels, and metadata) between Gmail accounts
- **Data Integrity**: Uses canonical hashes to ensure data consistency during migration
- **Resumable Operations**: Supports checkpointing to resume interrupted tasks
- **Label Management**: Preserves Gmail labels during migration
- **Testing**: Comprehensive integration tests for all major commands

### Architecture
- **CLI Framework**: Built with [Typer](https://typer.tiangolo.com/) for intuitive command-line interface
- **Gmail API**: Utilizes Google's Gmail API for email operations
- **Modular Design**: Commands are organized in separate modules for maintainability

## Code Understanding Guidelines

### CLI Command Structure
The tool is organized around modular CLI commands located in `src/gmail_copy_tool/commands/`:

- **`analyze.py`**: Count emails in Gmail accounts with filtering capabilities (by date, label)
- **`copy.py`**: Core email migration functionality with metadata preservation
- **`compare.py`**: Verify data integrity by comparing source and target accounts
- **`remove_copied.py`**: Clean up source emails that exist in target
- **`delete_duplicates.py`**: Remove duplicate emails within an account

**Priority Focus**: Pay special attention to the `copy.py` command's logic for:
- Gmail API interactions and rate limiting
- Date header preservation during migration
- Label mapping and preservation
- Attachment handling
- Error recovery and resumable operations

### Core Components
- **`src/gmail_copy_tool/core/gmail_client.py`**: Gmail API client wrapper
- **`src/gmail_copy_tool/utils/`**: Utility modules for:
  - `gmail_api_helpers.py`: API interaction helpers with backoff/retry logic
  - `canonicalization.py`: Email hashing for data integrity
  - `checkpoint.py`: State management for resumable operations
  - `timing.py`: Performance monitoring

## Testing Guidelines

### Integration Tests
Integration tests are located in `tests/test_integration.py` and require:
- Real Gmail API credentials for testing
- Configuration file `tests/test_config.json` (see `test_config_example.json`)

**Testing Focus Areas**:
- Invalid credential handling
- Gmail API rate limits and backoff behavior
- Partial failure scenarios and recovery
- Large inbox handling
- Label preservation accuracy
- Date/metadata integrity

**Test Configuration**: Use `test_config_example.json` as a reference for setting up test environments with appropriate Gmail accounts and credentials. The test config includes:
- Source and target Gmail account addresses
- Paths to OAuth token files for both accounts  
- Credential file paths for both accounts
- Optional filtering parameters (label, date ranges)

### Test Development Best Practices
- Cover edge cases in all new functionality
- Mock Gmail API responses for unit tests where appropriate
- Ensure integration tests can handle real API limitations
- Test error scenarios (network failures, quota exceeded, etc.)

## Debugging and Logging

### Logging Strategy
Debugging logs are critical for troubleshooting Gmail API behavior. When working on code:

- Use structured logging with appropriate levels (DEBUG, INFO, WARNING, ERROR)
- Include relevant context in log messages (email IDs, operation types, timestamps)
- Log API response details for debugging rate limits and quota issues
- Track operation progress for long-running tasks
- **Debug Mode**: Use `GMAIL_COPY_TOOL_DEBUG=1` environment variable to enable detailed debug logging

**Logging Improvements to Suggest**:
- Better traceability for Gmail API calls
- Performance metrics logging
- Clear error categorization (transient vs permanent failures)
- Progress indicators for batch operations
- Structured log output for easier parsing

## Documentation Requirements

### Primary Documentation
- **`README.md`**: English documentation with usage instructions and setup guide
- **`README-ITA.md`**: Italian translation of main documentation

**Documentation Maintenance**: Ensure any new features, configuration changes, or API updates are reflected in both documentation files. Maintain consistency between English and Italian versions.

### Documentation Standards
- Include clear installation and setup instructions
- Provide comprehensive CLI usage examples
- Document all configuration options and file formats
- Include troubleshooting guides for common issues

## Python Best Practices

### Code Quality Standards
- **Type Annotations**: Use type hints for all function parameters and return values
- **Docstrings**: Document all modules, classes, and functions with clear descriptions
- **PEP 8 Compliance**: Follow Python style guidelines consistently
- **Error Handling**: Implement robust error handling with informative messages

### Security Considerations
- **Credential Management**: All CLI commands must accept explicit token and credential file options
- **File Permissions**: Ensure credential files are handled securely
- **API Key Protection**: Never log or expose API credentials in output
- **Input Validation**: Validate all user inputs and file paths

## Gmail API Integration

### API Interaction Patterns
- **Rate Limiting**: Implement exponential backoff for API calls
- **Batch Operations**: Use batch requests where possible for efficiency
- **Error Handling**: Handle transient errors, quota limits, and network issues
- **Metadata Preservation**: Maintain email headers, labels, and timestamps accurately

### Common API Challenges
- **Rate Limits**: Gmail API has strict quotas that must be respected
- **Transient Errors**: Network issues and temporary API unavailability
- **Metadata Delays**: Sometimes metadata isn't immediately available after operations
- **Large Attachments**: Handle memory efficiently when processing large files

## Future Enhancement Areas

### Planned Features to Assist With
- **Filtering Options**: Implement filters by label, date range, sender, and other criteria
- **Dry-Run Mode**: Allow users to preview operations without making changes
- **Concurrency**: Add parallel processing for large inbox operations
- **Progress Reporting**: Enhanced progress indicators and ETA calculations
- **Configuration Files**: Support for configuration files to reduce command-line complexity

### Performance Optimizations
- **Caching**: Implement intelligent caching for API responses
- **Parallel Processing**: Add safe concurrency for independent operations
- **Memory Management**: Optimize memory usage for large email processing
- **Incremental Sync**: Support for incremental updates rather than full copies

## Environment Setup

### Required Files
- **`credentials.json`**: OAuth 2.0 client credentials from Google Cloud Console
- **`token_source.json`**: OAuth token for source Gmail account
- **`token_target.json`**: OAuth token for target Gmail account

### Setup Guidance
When helping users with environment setup:
1. Guide through Google Cloud Console OAuth setup
2. Explain scope requirements for Gmail API access
3. Help troubleshoot credential file format issues
4. Provide clear instructions for token generation and refresh

## Error Handling Best Practices

### Gmail API Error Categories
- **Authentication Errors**: Invalid credentials or expired tokens
- **Authorization Errors**: Insufficient permissions or scope issues
- **Rate Limiting**: Quota exceeded or too many requests
- **Transient Errors**: Network timeouts or temporary service unavailability
- **Data Errors**: Malformed emails or unsupported content

### Error Recovery Strategies
- Implement retry logic with exponential backoff
- Provide clear error messages with suggested remediation
- Support resumable operations after failures
- Log detailed error context for debugging

## Contribution Guidelines

### Code Quality Requirements
- **Typed Code**: All new code must include comprehensive type annotations
- **Tested Code**: Include unit tests and integration tests for new functionality
- **Documentation**: Update both English and Italian documentation
- **Code Review**: Ensure code follows project patterns and conventions

### Development Workflow
- Test changes against real Gmail API when possible
- Verify backwards compatibility with existing configurations
- Update CLI help text and documentation
- Consider performance impact of changes

## Localization Support

### Italian Documentation
The repository includes Italian documentation (`README-ITA.md`). When making changes:
- Update Italian documentation to match English changes
- Maintain consistency in technical terminology
- Preserve formatting and structure between versions
- Consider cultural context in documentation examples

---

## Environment Variables

### Debug Mode
- `GMAIL_COPY_TOOL_DEBUG=1`: Enable detailed debug logging for troubleshooting and development
- `GMAIL_COPY_TOOL_DEBUG=0`: Default production mode with minimal logging (recommended for end users)

Use debug mode when developing new features or troubleshooting API issues. Production users should use the default setting to avoid noisy logs.

## Quick Reference

### Key Commands
```bash
gmail-copy-tool analyze --help     # Email counting and analysis
gmail-copy-tool copy --help        # Core migration functionality  
gmail-copy-tool compare --help     # Data integrity verification
gmail-copy-tool remove-copied --help  # Source cleanup
gmail-copy-tool delete-duplicates --help  # Duplicate removal
```

### Important Files
- `src/gmail_copy_tool/commands/copy.py` - Core migration logic
- `src/gmail_copy_tool/utils/gmail_api_helpers.py` - API interaction utilities
- `tests/test_integration.py` - Integration test suite
- `README.md` / `README-ITA.md` - User documentation

### Testing
```bash
pip install -e .                   # Install in development mode
python -m pytest tests/ -v        # Run test suite
gmail-copy-tool --help            # Verify CLI functionality
```

Remember: Focus on data integrity, user experience, and robust error handling when suggesting improvements or implementing new features.